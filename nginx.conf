# ----------------------------------------------------
# 1. HTTP ë¸”ë¡ (80 í¬íŠ¸) - ACME ì±Œë¦°ì§€ ë° HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸
# ----------------------------------------------------
server {
    listen 80;
    server_name joyopi.com dev.joyopi.com;

    # Certbot ACME ì±Œë¦°ì§€ ê²€ì¦ ê²½ë¡œ ì„¤ì •
    # Certbotì´ ê°±ì‹  ì‹œ ì´ ê²½ë¡œë¥¼ í†µí•´ ê²€ì¦ íŒŒì¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # ë‚˜ë¨¸ì§€ ëª¨ë“  HTTP ìš”ì²­ì€ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (301: ì˜êµ¬ ì´ë™)
    location / {
        return 301 https://$host$request_uri;
    }
}

# ----------------------------------------------------
# 2. HTTPS - ìš´ì˜ í™˜ê²½ (joyopi.com)
# ----------------------------------------------------
server {
    listen 443 ssl;
    server_name joyopi.com;

    # SSL ì¸ì¦ì„œ ê²½ë¡œ ì„¤ì •
    # /etc/letsencryptëŠ” Docker Compose ë³¼ë¥¨ ë§ˆìš´íŠ¸ ê²½ë¡œì…ë‹ˆë‹¤.
    ssl_certificate /etc/letsencrypt/live/joyopi.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/joyopi.com/privkey.pem;
    
    # ê³µí†µ SSL ì˜µì…˜ íŒŒì¼ í¬í•¨ (ë³´ì•ˆ ê°•í™”ë¥¼ ìœ„í•œ Best Practice)
    # ì´ íŒŒì¼ì— ssl_dhparam ì„¤ì •ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, default.confì—ì„œëŠ” ì œê±°í•©ë‹ˆë‹¤.
    include /etc/letsencrypt/options-ssl-nginx.conf;
    
    # ğŸš¨ ì¤‘ë³µ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ì•„ë˜ ë¼ì¸ì€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    # ìºì‹œ ë° ì„±ëŠ¥ ìµœì í™” í—¤ë” (í•„ìš”ì‹œ ì¶”ê°€)
    # add_header X-Frame-Options "SAMEORIGIN";

    location / {
        # 'frontend-prod' ì»¨í…Œì´ë„ˆì˜ ë‚´ë¶€ 3001 í¬íŠ¸ë¡œ ìš”ì²­ ì „ë‹¬
        proxy_pass http://frontend-prod:3001;
        
        # í”„ë¡ì‹œ í—¤ë” ì„¤ì •
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ----------------------------------------------------
# 3. HTTPS - ê°œë°œ í™˜ê²½ (dev.joyopi.com)
# ----------------------------------------------------
server {
    listen 443 ssl;
    server_name dev.joyopi.com;

    # SSL ì¸ì¦ì„œ ê²½ë¡œ ì„¤ì • (ìš´ì˜ í™˜ê²½ê³¼ ë™ì¼í•œ ì¸ì¦ì„œ ì‚¬ìš©)
    ssl_certificate /etc/letsencrypt/live/joyopi.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/joyopi.com/privkey.pem;
    
    # ê³µí†µ SSL ì˜µì…˜ íŒŒì¼ í¬í•¨
    include /etc/letsencrypt/options-ssl-nginx.conf;
    
    # ğŸš¨ ì¤‘ë³µ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ì•„ë˜ ë¼ì¸ì€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        # 'frontend-dev' ì»¨í…Œì´ë„ˆì˜ ë‚´ë¶€ 3000 í¬íŠ¸ë¡œ ìš”ì²­ ì „ë‹¬
        proxy_pass http://frontend-dev:3000;
        
        # í”„ë¡ì‹œ í—¤ë” ì„¤ì •
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
