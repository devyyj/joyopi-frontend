version: '3.8' # 최신 Compose 파일 포맷 버전 사용

services:
  # ----------------------------------------------------
  # 1. Nginx 서비스 정의 (HTTP/HTTPS 프록시)
  # ----------------------------------------------------
  nginx:
    image: nginx:latest
    container_name: nginx-ssl-web
    
    # 80번 포트와 443번 포트를 호스트와 연결
    ports:
      - "80:80"
      - "443:443"
      
    # 중요한 볼륨 마운트 설정
    volumes:
      # 1. Nginx 설정 파일: 로컬 파일을 컨테이너 설정으로 사용
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      # 2. 인증서 파일: Certbot과 공유하는 인증서 저장 경로
      - ./certbot/conf:/etc/letsencrypt # 인증서 및 SSL 설정 파일 마운트
      # 3. Certbot 검증 경로: Let's Encrypt 검증을 위한 웹 루트
      - ./certbot/www:/var/www/certbot
      
    restart: always
    
    # Certbot 갱신 시 Nginx 설정 파일을 자동으로 다시 로드하도록 설정 (Best Practice)
    # Certbot이 갱신 성공 후 Nginx가 새로운 인증서를 로드하게 합니다.
    command: /bin/sh -c "while :; do sleep 6h & wait $!; nginx -s reload; done & nginx -g 'daemon off;'"

  # ----------------------------------------------------
  # 2. Certbot 서비스 정의 (주기적 갱신 담당)
  # ----------------------------------------------------
  certbot:
    image: certbot/certbot
    container_name: certbot-renew
    
    # Nginx와 동일한 볼륨 경로를 공유하여 인증서 파일을 읽고 쓸 수 있도록 합니다.
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      
    # Nginx가 80 포트를 점유하고 있을 때 ACME 챌린지 검증을 위해 필요합니다.
    depends_on:
      - nginx
      
    # 주기적 갱신 루프를 포함한 Entrypoint
    # 최초 발급은 완료되었으므로, 이제 Certbot에게 Nginx를 사용하여 갱신하라고 지시합니다.
    entrypoint: "/bin/sh -c 'trap exit TERM; \
      echo \"Starting renewal loop (every 12h)...\"; \
      # 주기적으로 인증서 갱신을 시도합니다. (Certbot은 만료가 임박해야 실제로 갱신)
      while :; do certbot renew --nginx; sleep 12h & wait $!; done;'"
      
  # ----------------------------------------------------
  # 3. 개발 프론트엔드 서비스 (dev.joyopi.com)
  # ----------------------------------------------------
  frontend-dev:
    image: ${DOCKER_REGISTRY_USER}/joyopi-frontend:dev
    container_name: frontend-dev
    expose:
      - "3000"
    restart: always

  # ----------------------------------------------------
  # 4. 운영 프론트엔드 서비스 (joyopi.com)
  # ----------------------------------------------------
  frontend-prod:
    image: ${DOCKER_REGISTRY_USER}/joyopi-frontend:prod
    container_name: frontend-prod
    expose:
      - "3001"
    restart: always
